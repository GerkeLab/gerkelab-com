---
title: Encrypting and Sharing Data Containing PHI
author: 
  - Garrick Aden-Buie
  - Travis Gerke
date: '2019-02-22'
slug: encrypting-and-share-phi
categories:
  - R
tags:
  - R
description: "Using the encryptr package to securely share data with collaborators"
weight: 20
hero_bg: "/img/hero/corey-agopian-106075-unsplash.jpg"
hero_credit: "[Corey Agopian](https://unsplash.com/photos/-yhpJ0BwLcU?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) on Unsplash"
---



<!-- Links -->
<div id="links-will-remove" class="section level4">
<h4>Links (will remove)</h4>
<ul>
<li><a href="https://github.com/SurgicalInformatics/encryptr">encryptr</a></li>
<li><a href="https://cran.r-project.org/web/packages/sodium/vignettes/intro.html">sodium</a></li>
<li><a href="https://github.com/ropensci/cyphr">cyphr</a></li>
<li><a href="https://github.com/gaborcsardi/secret">r-secret</a></li>
</ul>
</div>
<div id="skeleton-of-example" class="section level2">
<h2>Skeleton of Example</h2>
<pre class="r code-source"><code># remotes::install_github(&quot;SurgicalInformatics/encryptr&quot;)
library(encryptr)</code></pre>
<pre class="r code-source"><code>library(tidyverse)</code></pre>
<p>Three people who need to share data:</p>
<ul>
<li><p><strong>Org</strong>: The <strong>Owner</strong> or organization sharing the data</p></li>
<li><p><strong>Aiyana</strong>: A fully-cleared collaborator</p></li>
<li><p><strong>Zane</strong>: A collaborator who cannot access PHI</p></li>
</ul>
<p>To set up, we create a public/private key pair for each person.</p>
<pre class="r code-source"><code># I have to do this manually because encryptr doesn&#39;t expose the
# password argument in openssl::write_pem()

people &lt;- c(&quot;org&quot;, &quot;aiyana&quot;, &quot;zane&quot;)
for (person in people) {
  # straight out of ?openssl::rsa_keygen()
  key &lt;- openssl::rsa_keygen()
  pubkey &lt;- as.list(key)$pubkey
  openssl::write_pem(key, paste0(person, &quot;_private_key&quot;))
  openssl::write_pem(pubkey, paste0(person, &quot;_public_key&quot;))
}

dir()</code></pre>
<pre class="code-output"><code>## [1] &quot;aiyana_private_key&quot; &quot;aiyana_public_key&quot;  &quot;org_private_key&quot;   
## [4] &quot;org_public_key&quot;     &quot;zane_private_key&quot;   &quot;zane_public_key&quot;</code></pre>
<div id="the-owner-has-the-data-and-encrypts-it" class="section level3">
<h3>The owner has the data and encrypts it</h3>
<p>The owner has some data about breast cancer patients.</p>
<pre class="r code-source"><code>patient_data</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number primary_site                     date_dx   
##                    &lt;dbl&gt; &lt;chr&gt;                            &lt;chr&gt;     
##  1                984584 C503 (BREAST LIQ)                2009-02-01
##  2                534924 C509 (BREAST NOS)                2012-04-13
##  3                624219 C509 (BREAST NOS)                2010-04-25
##  4                112743 C503 (BREAST LIQ)                2014-12-03
##  5                261730 C383 (MEDIASTINUM NOS)           2014-08-27
##  6                194777 C508 (BREAST OVERLAPPING LESION) 2013-03-18
##  7                446950 C541 (ENDOMETRIUM)               2016-03-28
##  8                751595 C504 (BREAST UOQ)                2012-08-18
##  9                385615 C504 (BREAST UOQ)                2011-01-08
## 10                761953 C504 (BREAST UOQ)                2012-08-08</code></pre>
<p>They need to hide the Medical Record Number and Date of Diagnosis.</p>
<pre class="r code-source"><code>patient_encrypted &lt;- 
  patient_data %&gt;% 
  encrypt(
    medical_record_number,
    date_dx,
    public_key_path = &quot;org_public_key&quot;
  )

patient_encrypted</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number          primary_site      date_dx                
##    &lt;chr&gt;                          &lt;chr&gt;             &lt;chr&gt;                  
##  1 26419ad30c5d5e0d55defab4ea516… C503 (BREAST LIQ) 35cd4d3401bcb772077625…
##  2 b090bcba70a46c758a4f07805d462… C509 (BREAST NOS) 4718961a5dc27ec6e1f414…
##  3 8568e764ef2beff96117bdbc6f955… C509 (BREAST NOS) 8f24d55ee930097848bac3…
##  4 4bbc73fdd06285f8eed44fffa3002… C503 (BREAST LIQ) 0fd8812dbb07889d7ababb…
##  5 5707d3dbf42dfeabbfefe3dc77c3b… C383 (MEDIASTINU… 68c56e0f858615ad7a5737…
##  6 40ae762db62462ee3e27397a47076… C508 (BREAST OVE… 915b71918ede3c452ecf0e…
##  7 91682fc0f8f672ea3bc8b55192593… C541 (ENDOMETRIU… 877ac0660996929cb413e4…
##  8 4e55262497febb277c6ea4ae21efa… C504 (BREAST UOQ) a39115df45929e4e13e66b…
##  9 523d3ae659bf4e11555805cbe2f87… C504 (BREAST UOQ) a9063e3c4ed3823f26260f…
## 10 6874b8f672159765a74b63e2ec722… C504 (BREAST UOQ) a827cf261f3fd64769f66d…</code></pre>
<p>Can Aiyana or Zane see the data?</p>
<pre class="r code-source"><code>patient_encrypted %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;aiyana_private_key&quot;
  )</code></pre>
<pre><code>## Error: OpenSSL error in RSA_padding_check_PKCS1_type_2: pkcs decoding error</code></pre>
<pre class="r code-source"><code>patient_encrypted %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;zane_private_key&quot;
  )</code></pre>
<pre><code>## Error: OpenSSL error in RSA_padding_check_PKCS1_type_2: pkcs decoding error</code></pre>
<p>Nope.
But the Org can!</p>
<pre class="r code-source"><code>patient_encrypted %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;org_private_key&quot;
  )</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number primary_site                     date_dx   
##    &lt;chr&gt;                 &lt;chr&gt;                            &lt;chr&gt;     
##  1 984584                C503 (BREAST LIQ)                2009-02-01
##  2 534924                C509 (BREAST NOS)                2012-04-13
##  3 624219                C509 (BREAST NOS)                2010-04-25
##  4 112743                C503 (BREAST LIQ)                2014-12-03
##  5 261730                C383 (MEDIASTINUM NOS)           2014-08-27
##  6 194777                C508 (BREAST OVERLAPPING LESION) 2013-03-18
##  7 446950                C541 (ENDOMETRIUM)               2016-03-28
##  8 751595                C504 (BREAST UOQ)                2012-08-18
##  9 385615                C504 (BREAST UOQ)                2011-01-08
## 10 761953                C504 (BREAST UOQ)                2012-08-08</code></pre>
</div>
<div id="aiyana-wants-the-data" class="section level3">
<h3>Aiyana wants the data</h3>
<p>We encrypt for Aiyana to receive the data.</p>
<pre class="r code-source"><code>patient_encrypt_A &lt;- 
  patient_data %&gt;% 
  encrypt(
    medical_record_number, date_dx,
    public_key_path = &quot;aiyana_public_key&quot;
  )

patient_encrypt_A</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number          primary_site      date_dx                
##    &lt;chr&gt;                          &lt;chr&gt;             &lt;chr&gt;                  
##  1 8f9c0570c561b7a1c0686b23c80ec… C503 (BREAST LIQ) 793bf98a8cf9a6aed21812…
##  2 1ae8ed80b3ec907b435fe8dbedbf6… C509 (BREAST NOS) 9621226b0b78ce5253513e…
##  3 b35e425eb1fc1c28281d7c87a5745… C509 (BREAST NOS) 21aebd31df116df39a03a1…
##  4 059982379bafe24ad171ddd9f1269… C503 (BREAST LIQ) 1771bdcf67d119c8f2b2b2…
##  5 44035582897b71aaf1251a2a6ae35… C383 (MEDIASTINU… 9829e25e4ec1e8c2aff4b6…
##  6 6c201dc2072bd8d617a1a513803fc… C508 (BREAST OVE… 94287277b6e5813878b281…
##  7 9134cfe47464703a4cc5b6e55b0dc… C541 (ENDOMETRIU… 3490ed8dbf621fb9f2c794…
##  8 46b119d411c0a5b3f088ee9fa3438… C504 (BREAST UOQ) 8d97595362d032ba22034a…
##  9 a819299c13dc3d2a25945214e21e0… C504 (BREAST UOQ) 4aae2c87cac59a94b41b23…
## 10 5f57546a78e64b1d548d26a8f38a4… C504 (BREAST UOQ) 8b775125dd02fa6564d141…</code></pre>
<pre class="r code-source"><code>patient_encrypt_A %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;aiyana_private_key&quot;
  )</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number primary_site                     date_dx   
##    &lt;chr&gt;                 &lt;chr&gt;                            &lt;chr&gt;     
##  1 984584                C503 (BREAST LIQ)                2009-02-01
##  2 534924                C509 (BREAST NOS)                2012-04-13
##  3 624219                C509 (BREAST NOS)                2010-04-25
##  4 112743                C503 (BREAST LIQ)                2014-12-03
##  5 261730                C383 (MEDIASTINUM NOS)           2014-08-27
##  6 194777                C508 (BREAST OVERLAPPING LESION) 2013-03-18
##  7 446950                C541 (ENDOMETRIUM)               2016-03-28
##  8 751595                C504 (BREAST UOQ)                2012-08-18
##  9 385615                C504 (BREAST UOQ)                2011-01-08
## 10 761953                C504 (BREAST UOQ)                2012-08-08</code></pre>
<pre class="r code-source"><code>patient_encrypt_A %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;zane_private_key&quot;
  )</code></pre>
<pre><code>## Error: OpenSSL error in RSA_padding_check_PKCS1_type_2: pkcs decoding error</code></pre>
</div>
</div>
<div id="make-a-shared-key-system-work" class="section level2">
<h2>Make a Shared Key System Work</h2>
<p>An intereseting <a href="https://security.stackexchange.com/questions/71911/pattern-to-allow-multiple-persons-to-decrypt-a-document-without-sharing-the-enc#">StackOverflow discussion</a> leads to the following hypothetical workflow.</p>
<p>There are (essentially) two version of encryption: symmetric and asymmetric.
The version we have been looking at above is asymmetric: the private key is used for encryption and the public key is needed for decryption.
Symmtric encyption is when the same key is used to both encypt and decrypt.</p>
<p>Using both types of encryption, we could do something along the lines of the following, all of which are possible with <span class="pkg">openssl</span> (the package underlying <span class="pkg"><a href="https://github.com/SurgicalInformatics/encryptr">encryptr</a></span>).</p>
<ol style="list-style-type: decimal">
<li><p>Encrypt the data using a symmetric key, generated on a per-document basis</p></li>
<li><p>Store the symmetric key using asymmetric encryption, with N copies for each of the N potential users.
At a minimum, this stored key is encrypted for the Org.
This is called an “encrypted envelope” that can be thought of like a locked message that’s only readable by each individual user (see <code>?openssl::encrypt_envelope</code>).</p></li>
<li><p>When users need to decrpyt the data, they request the envelope which they can then decode using their private key, such that they now have the symmetric key needed to decrpyt the data.
This entire process can be done “invisibly” to the user.</p></li>
</ol>
<p>It’s unclear how much of this is possible with the <span class="pkg"><a href="https://github.com/SurgicalInformatics/encryptr">encryptr</a></span> package.
I think that the encryption methods are “hardcoded” into the <code>encrypt</code> and <code>decrypt</code> functions.</p>
<p>Actually, this process is documented in the <a href="https://github.com/ropensci/cyphr#collaborating-with-encrypted-data">cyphr package README</a>:</p>
<blockquote>
<p>The package contains support for a group of people are working on a sensitive data set. The data will be stored with a symmetric key. However, we never actually store the key directly, instead we’ll store a copy for each user that is encrypted with the user’s key. Any user with access to the data can authorise another user to access the data. This is described in more detail in the vignette (in R: <code>vignette("data", package = "cyphr")</code>).</p>
</blockquote>
</div>
