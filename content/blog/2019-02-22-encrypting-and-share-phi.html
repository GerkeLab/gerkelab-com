---
title: Encrypting and Sharing Data Containing PHI
author: 
  - Garrick Aden-Buie
  - Travis Gerke
date: '2019-02-22'
slug: encrypting-and-share-phi
categories:
  - R
tags:
  - R
description: "Using the encryptr package to securely share data with collaborators"
weight: 20
hero_bg: "/img/hero/corey-agopian-106075-unsplash.jpg"
hero_credit: "[Corey Agopian](https://unsplash.com/photos/-yhpJ0BwLcU?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) on Unsplash"
---



<!-- Links -->
<div id="links-will-remove" class="section level4">
<h4>Links (will remove)</h4>
<ul>
<li><a href="https://github.com/SurgicalInformatics/encryptr">encryptr</a></li>
<li><a href="https://cran.r-project.org/web/packages/sodium/vignettes/intro.html">sodium</a></li>
<li><a href="https://github.com/ropensci/cyphr">cyphr</a></li>
<li><a href="https://github.com/gaborcsardi/secret">r-secret</a></li>
</ul>
</div>
<div id="skeleton-of-example" class="section level2">
<h2>Skeleton of Example</h2>
<pre class="r code-source"><code># remotes::install_github(&quot;SurgicalInformatics/encryptr&quot;)
library(encryptr)</code></pre>
<pre class="r code-source"><code>library(tidyverse)</code></pre>
<p>Three people who need to share data:</p>
<ul>
<li><p><strong>Org</strong>: The <strong>Owner</strong> or organization sharing the data</p></li>
<li><p><strong>Aiyana</strong>: A fully-cleared collaborator</p></li>
<li><p><strong>Zane</strong>: A collaborator who cannot access PHI</p></li>
</ul>
<p>To set up, we create a public/private key pair for each person.</p>
<pre class="r code-source"><code># I have to do this manually because `encryptr` doesn&#39;t expose the
# password argument in openssl::write_pem()

people &lt;- c(&quot;org&quot;, &quot;aiyana&quot;, &quot;zane&quot;)
for (person in people) {
  # straight out of ?openssl::rsa_keygen()
  key &lt;- openssl::rsa_keygen()
  pubkey &lt;- as.list(key)$pubkey
  openssl::write_pem(key, paste0(person, &quot;_private_key&quot;))
  openssl::write_pem(pubkey, paste0(person, &quot;_public_key&quot;))
}

dir()</code></pre>
<pre class="code-output"><code>## [1] &quot;aiyana_private_key&quot; &quot;aiyana_public_key&quot;  &quot;org_private_key&quot;   
## [4] &quot;org_public_key&quot;     &quot;zane_private_key&quot;   &quot;zane_public_key&quot;</code></pre>
<div id="the-owner-has-the-data-and-encrypts-it" class="section level3">
<h3>The owner has the data and encrypts it</h3>
<p>The owner has some data about breast cancer patients.</p>
<pre class="r code-source"><code>patient_data</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number primary_site                     date_dx   
##                    &lt;dbl&gt; &lt;chr&gt;                            &lt;chr&gt;     
##  1                984584 C503 (BREAST LIQ)                2009-02-01
##  2                534924 C509 (BREAST NOS)                2012-04-13
##  3                624219 C509 (BREAST NOS)                2010-04-25
##  4                112743 C503 (BREAST LIQ)                2014-12-03
##  5                261730 C383 (MEDIASTINUM NOS)           2014-08-27
##  6                194777 C508 (BREAST OVERLAPPING LESION) 2013-03-18
##  7                446950 C541 (ENDOMETRIUM)               2016-03-28
##  8                751595 C504 (BREAST UOQ)                2012-08-18
##  9                385615 C504 (BREAST UOQ)                2011-01-08
## 10                761953 C504 (BREAST UOQ)                2012-08-08</code></pre>
<p>They need to hide the Medical Record Number and Date of Diagnosis.</p>
<pre class="r code-source"><code>patient_encrypted &lt;- 
  patient_data %&gt;% 
  encrypt(
    medical_record_number,
    date_dx,
    public_key_path = &quot;org_public_key&quot;
  )

patient_encrypted</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number          primary_site      date_dx                
##    &lt;chr&gt;                          &lt;chr&gt;             &lt;chr&gt;                  
##  1 4fa457943c707c89a06688a36eb3c… C503 (BREAST LIQ) 552fe32399c4e186f944d2…
##  2 3466a90db2d7c007c5e239cc5765e… C509 (BREAST NOS) 7970b280743cdb2a499c86…
##  3 6d454783645899cb3afbd7bc5e78e… C509 (BREAST NOS) c09fd9686964d8fdf161c4…
##  4 729f8382fb111ee7033ea586a7bad… C503 (BREAST LIQ) b600d66f5b093ef4ad543a…
##  5 4c5b8b843bfe312ab7ea8bea1f701… C383 (MEDIASTINU… 9d88fa81e090ad71c2b196…
##  6 20d4968ccb0ece2da547c1495d8f3… C508 (BREAST OVE… c0b257a14a1718f76d1652…
##  7 8aebe833bfb37946c39d0320d4939… C541 (ENDOMETRIU… 53500d98f54d1465c32438…
##  8 a30a4e74f000d6b16125ad1ee7930… C504 (BREAST UOQ) 56ccf2479e5f739f687937…
##  9 7cf2516d8e09ca496b85fa08d7d36… C504 (BREAST UOQ) beab4358d03b9f312aaf44…
## 10 3bc3fafbc0a75a6fc40d531dd1593… C504 (BREAST UOQ) 168f823e2ea0fa98e8de73…</code></pre>
<p>Can Aiyana or Zane see the data?</p>
<pre class="r code-source"><code>patient_encrypted %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;aiyana_private_key&quot;
  )</code></pre>
<pre><code>## Error: OpenSSL error in RSA_padding_check_PKCS1_type_2: pkcs decoding error</code></pre>
<pre class="r code-source"><code>patient_encrypted %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;zane_private_key&quot;
  )</code></pre>
<pre><code>## Error: OpenSSL error in RSA_padding_check_PKCS1_type_2: pkcs decoding error</code></pre>
<p>Nope.
But the Org can!</p>
<pre class="r code-source"><code>patient_encrypted %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;org_private_key&quot;
  )</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number primary_site                     date_dx   
##    &lt;chr&gt;                 &lt;chr&gt;                            &lt;chr&gt;     
##  1 984584                C503 (BREAST LIQ)                2009-02-01
##  2 534924                C509 (BREAST NOS)                2012-04-13
##  3 624219                C509 (BREAST NOS)                2010-04-25
##  4 112743                C503 (BREAST LIQ)                2014-12-03
##  5 261730                C383 (MEDIASTINUM NOS)           2014-08-27
##  6 194777                C508 (BREAST OVERLAPPING LESION) 2013-03-18
##  7 446950                C541 (ENDOMETRIUM)               2016-03-28
##  8 751595                C504 (BREAST UOQ)                2012-08-18
##  9 385615                C504 (BREAST UOQ)                2011-01-08
## 10 761953                C504 (BREAST UOQ)                2012-08-08</code></pre>
</div>
<div id="aiyana-wants-the-data" class="section level3">
<h3>Aiyana wants the data</h3>
<p>We encrypt for Aiyana to receive the data.</p>
<pre class="r code-source"><code>patient_encrypt_A &lt;- 
  patient_data %&gt;% 
  encrypt(
    medical_record_number, date_dx,
    public_key_path = &quot;aiyana_public_key&quot;
  )

patient_encrypt_A</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number          primary_site      date_dx                
##    &lt;chr&gt;                          &lt;chr&gt;             &lt;chr&gt;                  
##  1 b3893d7cab7d0cf0fd995c67a2dbd… C503 (BREAST LIQ) c736f17a3181891aea16e0…
##  2 1de5719d95f5266101ca4fb6d9f57… C509 (BREAST NOS) d46d9b022752663c989fcd…
##  3 205e4005b698552cc0397b36b8d88… C509 (BREAST NOS) c90aaad401ba744316bb8a…
##  4 14fb9ec409e1d21673e0ab1f41f76… C503 (BREAST LIQ) a442821b89aec5331c4e0d…
##  5 b0ae0ce9e90e99ddca174dc8cefc2… C383 (MEDIASTINU… a0b1b63a323df5eb1e2187…
##  6 ba08f676a4e80fc566ad27e2e7baa… C508 (BREAST OVE… 032ca6772eb27e274fd687…
##  7 53edf8ed606590566255a39f933a0… C541 (ENDOMETRIU… bd841eb353980ca10c00a8…
##  8 08f3354fb4c1a85b8f5585aca2f46… C504 (BREAST UOQ) b58da8f02cd2dfa43bdeeb…
##  9 91852c9e4729b0efef936b6d26ce4… C504 (BREAST UOQ) 49d9563ca4b1e81e03a1cb…
## 10 0c03655e150bdecefebddd8be5304… C504 (BREAST UOQ) 762f7e2e9ca8c6cc0c310d…</code></pre>
<pre class="r code-source"><code>patient_encrypt_A %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;aiyana_private_key&quot;
  )</code></pre>
<pre class="code-output"><code>## # A tibble: 10 x 3
##    medical_record_number primary_site                     date_dx   
##    &lt;chr&gt;                 &lt;chr&gt;                            &lt;chr&gt;     
##  1 984584                C503 (BREAST LIQ)                2009-02-01
##  2 534924                C509 (BREAST NOS)                2012-04-13
##  3 624219                C509 (BREAST NOS)                2010-04-25
##  4 112743                C503 (BREAST LIQ)                2014-12-03
##  5 261730                C383 (MEDIASTINUM NOS)           2014-08-27
##  6 194777                C508 (BREAST OVERLAPPING LESION) 2013-03-18
##  7 446950                C541 (ENDOMETRIUM)               2016-03-28
##  8 751595                C504 (BREAST UOQ)                2012-08-18
##  9 385615                C504 (BREAST UOQ)                2011-01-08
## 10 761953                C504 (BREAST UOQ)                2012-08-08</code></pre>
<pre class="r code-source"><code>patient_encrypt_A %&gt;% 
  decrypt(
    medical_record_number,
    date_dx,
    private_key_path = &quot;zane_private_key&quot;
  )</code></pre>
<pre><code>## Error: OpenSSL error in RSA_padding_check_PKCS1_type_2: pkcs decoding error</code></pre>
</div>
</div>
